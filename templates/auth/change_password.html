<!-- templates/auth/change_password.html -->
{% extends 'base.html' %}

{% block title %}تغيير كلمة المرور - موقع كنوز {% endblock %}

{% block extra_css %}
<style>
    .password-strength {
        height: 5px;
        transition: all 0.3s ease;
    }
    
    .password-requirements {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    
    .password-requirements.show {
        max-height: 300px;
    }
    
    .requirement-item {
        transition: all 0.3s ease;
    }
    
    .requirement-item.valid {
        color: #10b981;
    }
    
    .requirement-item.valid i {
        color: #10b981;
    }
    
    .password-toggle {
        cursor: pointer;
        transition: color 0.3s ease;
    }
    
    .password-toggle:hover {
        color: #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100 py-12 px-4">
    <div class="container mx-auto max-w-md">
        <!-- بطاقة تغيير كلمة المرور -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
            <!-- الهيدر -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-center">
                <div class="flex justify-center mb-4">
                    <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                        <i class="fas fa-lock text-white text-2xl"></i>
                    </div>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">تغيير كلمة المرور</h1>
                <p class="text-blue-100">تحديث كلمة المرور لحسابك الشخصي</p>
            </div>
            
            <!-- محتوى النموذج -->
            <div class="p-6">
                <!-- رسائل التنبيه -->
                {% if messages %}
                <div class="mb-6 space-y-3">
                    {% for message in messages %}
                    <div class="{% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-700{% elif message.tags == 'error' %}bg-red-50 border border-red-200 text-red-700{% else %}bg-blue-50 border border-blue-200 text-blue-700{% endif %} p-4 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %} ml-2"></i>
                            {{ message }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- معلومات الحساب -->
                <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-4 rounded-xl mb-6 border border-gray-200">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white text-lg font-bold ml-3">
                            {{ user.first_name|default:user.username|first|upper }}
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">{{ user.get_full_name|default:user.username }}</h3>
                            <p class="text-sm text-gray-600">{{ user.email }}</p>
                        </div>
                    </div>
                </div>
                
                <!-- نموذج تغيير كلمة المرور -->
                <form method="post" class="space-y-6" id="password-change-form">
                    {% csrf_token %}
                    
                    <!-- كلمة المرور الحالية -->
                    <div>
                        <label for="id_old_password" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-key text-blue-500 ml-1"></i>
                            كلمة المرور الحالية
                        </label>
                        <div class="relative">
                            <input type="password" 
                                   name="old_password" 
                                   id="id_old_password" 
                                   required
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                   placeholder="أدخل كلمة المرور الحالية">
                            <button type="button" 
                                    class="password-toggle absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-blue-600"
                                    data-target="id_old_password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.old_password.errors %}
                        <div class="mt-2 text-red-600 text-sm flex items-center">
                            <i class="fas fa-exclamation-circle ml-1"></i>
                            {{ form.old_password.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- كلمة المرور الجديدة -->
                    <div>
                        <label for="id_new_password1" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock text-green-500 ml-1"></i>
                            كلمة المرور الجديدة
                        </label>
                        <div class="relative">
                            <input type="password" 
                                   name="new_password1" 
                                   id="id_new_password1" 
                                   required
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                   placeholder="أدخل كلمة المرور الجديدة">
                            <button type="button" 
                                    class="password-toggle absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-blue-600"
                                    data-target="id_new_password1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        
                        <!-- قوة كلمة المرور -->
                        <div class="mt-3">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm text-gray-600">قوة كلمة المرور</span>
                                <span class="text-sm font-medium" id="password-strength-text">ضعيفة</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-red-500 h-2 rounded-full w-1/4" id="password-strength-bar"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تأكيد كلمة المرور الجديدة -->
                    <div>
                        <label for="id_new_password2" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock-check text-purple-500 ml-1"></i>
                            تأكيد كلمة المرور الجديدة
                        </label>
                        <div class="relative">
                            <input type="password" 
                                   name="new_password2" 
                                   id="id_new_password2" 
                                   required
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                   placeholder="أعد إدخال كلمة المرور الجديدة">
                            <button type="button" 
                                    class="password-toggle absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-blue-600"
                                    data-target="id_new_password2">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="mt-2" id="password-match-message"></div>
                        {% if form.new_password2.errors %}
                        <div class="mt-2 text-red-600 text-sm flex items-center">
                            <i class="fas fa-exclamation-circle ml-1"></i>
                            {{ form.new_password2.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- متطلبات كلمة المرور -->
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-4 rounded-xl border border-gray-200">
                        <div class="flex items-center justify-between mb-3 cursor-pointer" onclick="toggleRequirements()">
                            <h4 class="font-bold text-gray-800">
                                <i class="fas fa-info-circle text-blue-500 ml-1"></i>
                                متطلبات كلمة المرور الآمنة
                            </h4>
                            <i class="fas fa-chevron-down text-gray-500 transition-transform" id="requirements-icon"></i>
                        </div>
                        
                        <div class="password-requirements" id="password-requirements">
                            <div class="space-y-2">
                                <div class="requirement-item" id="req-length">
                                    <i class="far fa-circle text-gray-400 ml-2"></i>
                                    <span class="text-sm text-gray-600">8 أحرف على الأقل</span>
                                </div>
                                <div class="requirement-item" id="req-uppercase">
                                    <i class="far fa-circle text-gray-400 ml-2"></i>
                                    <span class="text-sm text-gray-600">حرف كبير على الأقل (A-Z)</span>
                                </div>
                                <div class="requirement-item" id="req-lowercase">
                                    <i class="far fa-circle text-gray-400 ml-2"></i>
                                    <span class="text-sm text-gray-600">حرف صغير على الأقل (a-z)</span>
                                </div>
                                <div class="requirement-item" id="req-number">
                                    <i class="far fa-circle text-gray-400 ml-2"></i>
                                    <span class="text-sm text-gray-600">رقم على الأقل (0-9)</span>
                                </div>
                                <div class="requirement-item" id="req-special">
                                    <i class="far fa-circle text-gray-400 ml-2"></i>
                                    <span class="text-sm text-gray-600">رمز خاص على الأقل (@#$%^&+=)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- نصائح أمنية -->
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl border border-yellow-200">
                        <h4 class="font-bold text-yellow-800 mb-3 flex items-center">
                            <i class="fas fa-shield-alt text-yellow-500 ml-1"></i>
                            نصائح لأمان أفضل
                        </h4>
                        <ul class="text-sm text-yellow-700 space-y-2">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-yellow-500 mt-0.5 ml-2"></i>
                                <span>استخدم كلمة مرور مختلفة لكل حساب مهم</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-yellow-500 mt-0.5 ml-2"></i>
                                <span>تجنب استخدام المعلومات الشخصية (اسم، تاريخ ميلاد)</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-yellow-500 mt-0.5 ml-2"></i>
                                <span>غير كلمة المرور بانتظام (كل 3-6 أشهر)</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-yellow-500 mt-0.5 ml-2"></i>
                                <span>استخدم مدير كلمات المرور لتذكرها</span>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- أزرار الإجراءات -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-6">
                        <button type="submit" 
                                class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-6 rounded-lg font-medium hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300 transform hover:-translate-y-0.5 shadow-lg">
                            <i class="fas fa-save ml-2"></i>
                            حفظ التغييرات
                        </button>
                        
                        <a href="{% url 'profile' %}" 
                           class="flex-1 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 py-3 px-6 rounded-lg font-medium hover:from-gray-200 hover:to-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-300 text-center">
                            <i class="fas fa-times ml-2"></i>
                            إلغاء
                        </a>
                    </div>
                    
                    <!-- روابط إضافية -->
                    <div class="pt-6 border-t border-gray-200 text-center">
                        <div class="space-y-3">
                            <a href="{% url 'password_reset' %}" 
                               class="text-blue-600 hover:text-blue-800 text-sm font-medium inline-flex items-center">
                                <i class="fas fa-key ml-2"></i>
                                نسيت كلمة المرور الحالية؟
                            </a>
                            <p class="text-gray-500 text-sm">
                                تغيير كلمة المرور يؤدي إلى تسجيل خروجك من جميع الأجهزة الأخرى.
                            </p>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- الفوتر -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 border-t border-gray-200">
                <div class="flex items-center justify-between text-sm text-gray-600">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-gray-400 ml-2"></i>
                        <span>آخر تغيير: 
                            {% if user.last_login %}
                                {{ user.last_login|timesince }}
                            {% else %}
                                غير متوفر
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-shield-alt text-green-500 ml-2"></i>
                        <span>اتصال آمن (HTTPS)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- معلومات إضافية -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- نصائح الأمان -->
            <div class="bg-gradient-to-br from-white to-green-50 rounded-xl p-6 shadow-md border border-green-100">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center ml-3">
                        <i class="fas fa-user-shield text-green-600"></i>
                    </div>
                    <h3 class="font-bold text-gray-800">حماية حسابك</h3>
                </div>
                <ul class="text-sm text-gray-700 space-y-2">
                    <li>• تفعيل المصادقة الثنائية للطبقة الأمنية الإضافية</li>
                    <li>• تجنب استخدام شبكات الواي فاي العامة عند تغيير كلمة المرور</li>
                    <li>• تأكد من أنك على الموقع الرسمي ({{ request.get_host }})</li>
                    <li>• تحقق بانتظام من نشاط حسابك</li>
                </ul>
            </div>
            
            <!-- ماذا يحدث بعد التغيير -->
            <div class="bg-gradient-to-br from-white to-blue-50 rounded-xl p-6 shadow-md border border-blue-100">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center ml-3">
                        <i class="fas fa-sync-alt text-blue-600"></i>
                    </div>
                    <h3 class="font-bold text-gray-800">بعد تغيير كلمة المرور</h3>
                </div>
                <ul class="text-sm text-gray-700 space-y-2">
                    <li>• سيتم تسجيل خروجك من جميع الأجهزة الأخرى تلقائياً</li>
                    <li>• سيتم إرسال بريد إلكتروني تأكيد إلى {{ user.email }}</li>
                    <li>• يمكنك تسجيل الدخول فوراً بالكلمة الجديدة</li>
                    <li>• تأكد من تحديث كلمة المرور في تطبيقات الهاتف إن وجدت</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // دالة لعرض/إخفاء متطلبات كلمة المرور
    function toggleRequirements() {
        const requirements = document.getElementById('password-requirements');
        const icon = document.getElementById('requirements-icon');
        
        requirements.classList.toggle('show');
        icon.classList.toggle('fa-chevron-down');
        icon.classList.toggle('fa-chevron-up');
    }

    // دالة لعرض/إخفاء كلمة المرور
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButtons = document.querySelectorAll('.password-toggle');
        
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                const icon = this.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });
        
        // فحص قوة كلمة المرور
        const passwordInput = document.getElementById('id_new_password1');
        const confirmInput = document.getElementById('id_new_password2');
        const strengthBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');
        
        if (passwordInput) {
            passwordInput.addEventListener('input', checkPasswordStrength);
        }
        
        if (confirmInput) {
            confirmInput.addEventListener('input', checkPasswordMatch);
        }
    });

    // فحص قوة كلمة المرور
    function checkPasswordStrength() {
        const password = document.getElementById('id_new_password1').value;
        const strengthBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');
        
        let strength = 0;
        const requirements = {
            length: false,
            uppercase: false,
            lowercase: false,
            number: false,
            special: false
        };
        
        // اختبار طول كلمة المرور
        if (password.length >= 8) {
            strength += 20;
            requirements.length = true;
            updateRequirement('req-length', true);
        } else {
            updateRequirement('req-length', false);
        }
        
        // اختبار الحروف الكبيرة
        if (/[A-Z]/.test(password)) {
            strength += 20;
            requirements.uppercase = true;
            updateRequirement('req-uppercase', true);
        } else {
            updateRequirement('req-uppercase', false);
        }
        
        // اختبار الحروف الصغيرة
        if (/[a-z]/.test(password)) {
            strength += 20;
            requirements.lowercase = true;
            updateRequirement('req-lowercase', true);
        } else {
            updateRequirement('req-lowercase', false);
        }
        
        // اختبار الأرقام
        if (/[0-9]/.test(password)) {
            strength += 20;
            requirements.number = true;
            updateRequirement('req-number', true);
        } else {
            updateRequirement('req-number', false);
        }
        
        // اختبار الرموز الخاصة
        if (/[@#$%^&+=]/.test(password)) {
            strength += 20;
            requirements.special = true;
            updateRequirement('req-special', true);
        } else {
            updateRequirement('req-special', false);
        }
        
        // تحديث شريط القوة والنص
        strengthBar.style.width = strength + '%';
        
        if (strength <= 20) {
            strengthBar.style.backgroundColor = '#ef4444';
            strengthText.textContent = 'ضعيفة جداً';
            strengthText.className = 'text-sm font-medium text-red-600';
        } else if (strength <= 40) {
            strengthBar.style.backgroundColor = '#f59e0b';
            strengthText.textContent = 'ضعيفة';
            strengthText.className = 'text-sm font-medium text-yellow-600';
        } else if (strength <= 60) {
            strengthBar.style.backgroundColor = '#3b82f6';
            strengthText.textContent = 'جيدة';
            strengthText.className = 'text-sm font-medium text-blue-600';
        } else if (strength <= 80) {
            strengthBar.style.backgroundColor = '#10b981';
            strengthText.textContent = 'قوية';
            strengthText.className = 'text-sm font-medium text-green-600';
        } else {
            strengthBar.style.backgroundColor = '#059669';
            strengthText.textContent = 'قوية جداً';
            strengthText.className = 'text-sm font-medium text-emerald-600';
        }
        
        // فحص مطابقة كلمة المرور
        checkPasswordMatch();
    }

    // تحديث حالة متطلبات كلمة المرور
    function updateRequirement(elementId, isValid) {
        const element = document.getElementById(elementId);
        const icon = element.querySelector('i');
        
        if (isValid) {
            element.classList.add('valid');
            icon.classList.remove('fa-circle', 'far');
            icon.classList.add('fa-check-circle', 'fas');
        } else {
            element.classList.remove('valid');
            icon.classList.remove('fa-check-circle', 'fas');
            icon.classList.add('fa-circle', 'far');
        }
    }

    // فحص مطابقة كلمة المرور
    function checkPasswordMatch() {
        const password = document.getElementById('id_new_password1').value;
        const confirm = document.getElementById('id_new_password2').value;
        const messageDiv = document.getElementById('password-match-message');
        
        if (confirm.length === 0) {
            messageDiv.innerHTML = '';
            return;
        }
        
        if (password === confirm) {
            messageDiv.innerHTML = `
                <div class="flex items-center text-green-600 text-sm">
                    <i class="fas fa-check-circle ml-2"></i>
                    كلمات المرور متطابقة
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="flex items-center text-red-600 text-sm">
                    <i class="fas fa-exclamation-circle ml-2"></i>
                    كلمات المرور غير متطابقة
                </div>
            `;
        }
    }

    // التحقق من صحة النموذج قبل الإرسال
    document.getElementById('password-change-form').addEventListener('submit', function(event) {
        const password = document.getElementById('id_new_password1').value;
        const confirm = document.getElementById('id_new_password2').value;
        
        if (password !== confirm) {
            event.preventDefault();
            alert('كلمات المرور غير متطابقة. يرجى التأكد من مطابقة كلمة المرور الجديدة مع تأكيدها.');
            return false;
        }
        
        if (password.length < 8) {
            event.preventDefault();
            alert('كلمة المرور يجب أن تكون 8 أحرف على الأقل.');
            return false;
        }
        
        // يمكن إضافة المزيد من التحقق هنا
        return true;
    });

    // تهيئة فحص قوة كلمة المرور عند التحميل
    window.onload = function() {
        checkPasswordStrength();
        // فتح متطلبات كلمة المرور إذا كانت هناك أخطاء
        const hasErrors = document.querySelector('.text-red-600');
        if (hasErrors) {
            toggleRequirements();
        }
    };
</script>

<!-- أنيميشن بسيطة -->
<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .bg-white {
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.8;
        }
    }

    button[type="submit"]:hover {
        animation: pulse 1s infinite;
    }
</style>


{% endblock %}